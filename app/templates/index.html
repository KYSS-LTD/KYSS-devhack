{% extends 'base.html' %}

{% block title %}Главная{% endblock %}

{% block card %}

    <div class="absolute inset-0 rounded-3xl pointer-events-none
                bg-gradient-to-br from-white/40 to-transparent
                dark:from-white/5"></div>

    <!-- ===== VIEW: JOIN ===== -->
    <div id="viewJoin" class="relative space-y-6">

      <p id="join-msg" class="hidden text-sm text-center text-red-500 dark:text-red-400 -mb-2"></p>

      <!-- Nickname — only guests -->
      <div id="joinNicknameWrap"></div>

      <div>
        <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">Код лобби</label>
        <input id="join-pin" type="text" placeholder="A1B2C3" maxlength="6"
               class="w-full bg-transparent
                      border border-slate-300 dark:border-slate-700
                      rounded-xl px-4 py-3
                      text-center tracking-widest text-lg
                      focus:outline-none focus:ring-2 focus:ring-indigo-400/60
                      dark:focus:ring-indigo-500/60 transition" />
      </div>

      <button id="joinBtn" type="button"
              class="w-full py-3 rounded-xl font-semibold
                     bg-indigo-600 text-white hover:bg-indigo-500
                     active:scale-[0.98] transition">
        Войти
      </button>

      <div class="flex items-center gap-4 text-sm text-slate-400">
        <div class="flex-1 h-px bg-slate-300 dark:bg-slate-700"></div>
        или
        <div class="flex-1 h-px bg-slate-300 dark:bg-slate-700"></div>
      </div>

      <button id="showCreateBtn" type="button"
              class="w-full py-3 rounded-xl font-medium
                     border border-slate-300 dark:border-slate-700
                     hover:bg-slate-100 dark:hover:bg-slate-800 transition">
        Создать лобби
      </button>
    </div>

    <!-- ===== VIEW: CREATE ===== -->
    <div id="viewCreate" class="relative space-y-6 hidden">

      <div class="flex items-center gap-3">
        <button id="backToJoinBtn" type="button"
                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition flex-shrink-0"
                title="Назад">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <span class="text-sm font-semibold text-slate-500 dark:text-slate-400 tracking-wide uppercase">
          Новая игра
        </span>
      </div>

      <p id="create-msg" class="hidden text-sm text-center text-red-500 dark:text-red-400 -mb-2"></p>

      <!-- Host name — only guests -->
      <div id="createHostWrap"></div>

      <div>
        <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">Тема вопросов</label>
        <input id="create-topic" type="text" minlength="2" maxlength="255"
               placeholder="Например: История России"
               class="w-full bg-transparent
                      border border-slate-300 dark:border-slate-700
                      rounded-xl px-4 py-3
                      focus:outline-none focus:ring-2 focus:ring-indigo-400/60
                      dark:focus:ring-indigo-500/60 transition" />
      </div>

      <div>
        <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">Вопросов на команду</label>
        <select id="create-qpt"
                class="w-full bg-white dark:bg-slate-800
                       border border-slate-300 dark:border-slate-700
                       rounded-xl px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-indigo-400/60
                       dark:focus:ring-indigo-500/60 transition cursor-pointer">
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
        </select>
      </div>

      <div>
        <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">Сложность</label>
        <select id="create-difficulty"
                class="w-full bg-white dark:bg-slate-800
                       border border-slate-300 dark:border-slate-700
                       rounded-xl px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-indigo-400/60
                       dark:focus:ring-indigo-500/60 transition cursor-pointer">
          <option value="easy">Простой</option>
          <option value="medium" selected>Средний</option>
          <option value="hard">Сложный</option>
        </select>
      </div>

      <button id="createBtn" type="button"
              class="w-full py-3 rounded-xl font-semibold
                     bg-indigo-600 text-white hover:bg-indigo-500
                     active:scale-[0.98] transition">
        Создать игру
      </button>
    </div>



  <script>
  const user = window.qbUser;

  /* ===== NAME FIELDS ===== */

  const joinNicknameWrap = document.getElementById('joinNicknameWrap');
  const createHostWrap   = document.getElementById('createHostWrap');

  const inputClasses = `
    w-full bg-transparent
    border border-slate-300 dark:border-slate-700
    rounded-xl px-4 py-3
    focus:outline-none focus:ring-2 focus:ring-indigo-400/60
    dark:focus:ring-indigo-500/60 transition
  `;

  const defaultName = user?.username ?? '';

  joinNicknameWrap.innerHTML = `
    <div>
      <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">
        Никнейм
      </label>
      <input id="join-name" type="text"
             placeholder="Ваш ник"
             maxlength="80"
             value="${defaultName}"
             class="${inputClasses}" />
    </div>`;

  createHostWrap.innerHTML = `
    <div>
      <label class="block text-sm mb-2 text-slate-500 dark:text-slate-400">
        Имя ведущего
      </label>
      <input id="host-name" type="text"
             placeholder="Ваш ник"
             maxlength="80"
             value="${defaultName}"
             class="${inputClasses}" />
    </div>`;

  function getJoinName() {
    return document.getElementById('join-name')?.value.trim() ?? '';
  }

  function getHostName() {
    return document.getElementById('host-name')?.value.trim() ?? '';
  }


  /* ===== VIEW SWITCHING ===== */

  const viewJoin   = document.getElementById('viewJoin');
  const viewCreate = document.getElementById('viewCreate');

  document.getElementById('showCreateBtn')
    .addEventListener('click', function () {
      viewJoin.classList.add('hidden');
      viewCreate.classList.remove('hidden');
    });

  document.getElementById('backToJoinBtn')
    .addEventListener('click', function () {
      viewCreate.classList.add('hidden');
      viewJoin.classList.remove('hidden');
      qb.hideMsg('create-msg');
    });


  /* ===== PIN AUTO UPPERCASE ===== */

  document.getElementById('join-pin')
    .addEventListener('input', function () {
      this.value = this.value.toUpperCase();
    });


  /* ===== JOIN ===== */

  document.getElementById('joinBtn')
    .addEventListener('click', async function () {

      qb.hideMsg('join-msg');

      const pin  = document.getElementById('join-pin')
                      .value.trim().toUpperCase();

      const name = getJoinName();

      if (!pin || pin.length !== 6) {
        qb.showMsg('join-msg', 'Введите 6-значный код лобби');
        return;
      }

      if (!name) {
        qb.showMsg('join-msg', 'Укажите никнейм');
        return;
      }

      qb.setLoading('joinBtn', true, 'Войти');

      try {

        const res = await fetch(`/games/${pin}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            user_id: null
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.detail || 'Ошибка подключения');
        }

        localStorage.setItem('qb_player', JSON.stringify({
          pin,
          player_id: data.player_id,
          player_token: data.player_token,
          name,
          is_host: false
        }));

        window.location.href = `/game/${pin}`;

      } catch (err) {
        qb.showMsg('join-msg', err.message);
      } finally {
        qb.setLoading('joinBtn', false, 'Войти');
      }

    });


  /* ===== CREATE ===== */

  document.getElementById('createBtn')
    .addEventListener('click', async function () {

      qb.hideMsg('create-msg');

      const host_name = getHostName();
      const topic     = document.getElementById('create-topic')
                          .value.trim();
      const questions_per_team =
        Number(document.getElementById('create-qpt').value);
      const difficulty = document.getElementById('create-difficulty').value;

      if (!host_name) {
        qb.showMsg('create-msg', 'Укажите имя ведущего');
        return;
      }

      if (!topic || topic.length < 2) {
        qb.showMsg('create-msg', 'Введите тему (минимум 2 символа)');
        return;
      }

      qb.setLoading('createBtn', true, 'Создать игру');

      try {

        const res = await fetch('/games', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            host_name,
            topic,
            questions_per_team,
            difficulty,
            user_id: null
          })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.detail || 'Ошибка создания игры');
        }

        localStorage.setItem('qb_player', JSON.stringify({
          pin: data.pin,
          player_id: data.host_player_id,
          player_token: data.player_token,
          name: host_name,
          is_host: true
        }));

        window.location.href = `/game/${data.pin}`;

      } catch (err) {
        qb.showMsg('create-msg', err.message);
      } finally {
        qb.setLoading('createBtn', false, 'Создать игру');
      }

    });

  </script>
{% endblock %}